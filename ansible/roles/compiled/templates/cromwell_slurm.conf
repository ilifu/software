include required(classpath("application"))

backend {
  default = "SLURM"

  providers {
    SLURM {
	  actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"
	  config {
		runtime-attributes = """
		Int runtime_minutes = 600
		Int cpu = 0
		Int cpus = 2
		Int memory = 0
		Int requested_memory_mb_per_core = 7100
		String queue = "Main"
		"""

		submit = """
			if [ -n "${cpu}" ] && [ "${cpu}" -gt 0 ] && [ -n "${cpus}" ] && [ "${cpus}" -gt 0 ]; then
			  echo "ERROR: Cannot specify both 'cpu' and 'cpus'" >&2
			  exit 1
			fi
			if [ -n "${memory}" ] && [ "${memory}" -gt 0 ] && [ -n "${requested_memory_mb_per_core}" ] && [ "${requested_memory_mb_per_core}" -gt 0 ]; then
			  echo "ERROR: Cannot specify both 'memory' and 'requested_memory_mb_per_core'" >&2
			  exit 1
			fi
			CPU_FLAG=""
			if [ -n "${cpu}" ] && [ "${cpu}" -gt 0 ]; then
			  CPU_FLAG="-c ${cpu}"
			elif [ -n "${cpus}" ] && [ "${cpus}" -gt 0 ]; then
			  CPU_FLAG="-c ${cpus}"
			fi
			MEMORY_FLAG=""
			if [ -n "${memory}" ] && [ "${memory}" -gt 0 ]; then
			  MEMORY_FLAG="--mem ${memory}"
			else
			  MEMORY_FLAG="--mem-per-cpu ${requested_memory_mb_per_core}"
			fi
			sbatch -J ${job_name} -D ${cwd} -o ${out} -e ${err} -t ${runtime_minutes} -p ${queue} \
			${CPU_FLAG} ${MEMORY_FLAG} \
			--wrap "/bin/bash ${script}"
		"""

		submit-docker = """
			if [ -z $SINGULARITY_CACHEDIR ];
				then CACHE_DIR=$HOME/.singularity/cache
			else CACHE_DIR=$SINGULARITY_CACHEDIR
			fi
			mkdir -p $CACHE_DIR
			LOCK_FILE=$CACHE_DIR/singularity_pull_flock
			flock --verbose --exclusive --timeout 900 $LOCK_FILE \
			singularity exec --containall docker://${docker} \
			echo "successfully pulled ${docker}!"

			if [ -n "${cpu}" ] && [ "${cpu}" -gt 0 ] && [ -n "${cpus}" ] && [ "${cpus}" -gt 0 ]; then
			  echo "ERROR: Cannot specify both 'cpu' and 'cpus'" >&2
			  exit 1
			fi
			if [ -n "${memory}" ] && [ "${memory}" -gt 0 ] && [ -n "${requested_memory_mb_per_core}" ] && [ "${requested_memory_mb_per_core}" -gt 0 ]; then
			  echo "ERROR: Cannot specify both 'memory' and 'requested_memory_mb_per_core'" >&2
			  exit 1
			fi
			CPU_FLAG=""
			if [ -n "${cpu}" ] && [ "${cpu}" -gt 0 ]; then
			  CPU_FLAG="-c ${cpu}"
			elif [ -n "${cpus}" ] && [ "${cpus}" -gt 0 ]; then
			  CPU_FLAG="-c ${cpus}"
			fi
			MEMORY_FLAG=""
			if [ -n "${memory}" ] && [ "${memory}" -gt 0 ]; then
			  MEMORY_FLAG="--mem ${memory}"
			else
			  MEMORY_FLAG="--mem-per-cpu ${requested_memory_mb_per_core}"
			fi
			sbatch -J ${job_name} -D ${cwd} -o ${out} -e ${err} -t ${runtime_minutes} -p ${queue} \
			${CPU_FLAG} ${MEMORY_FLAG} \
			--wrap "singularity exec --containall --bind ${cwd}:${docker_cwd} docker://${docker} ${job_shell} ${docker_script}"
		"""

		kill = "scancel ${job_id}"
		check-alive = "squeue -j ${job_id}"
		job-id-regex = "Submitted batch job (\\d+).*"
	  }
	}
  }
}
