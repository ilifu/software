---
- name: Install snpeff from source {{ item.version_number }}
  vars:
    snpeff_dir: "{{ bio_dir }}/snpEff"
    snpeff_install_dir: "{{ snpeff_dir }}/{{ item.version_number }}"
    snpeff_build_dir: "{{ bio_src }}/SnpEff-{{ item.version_number }}"
    snpsift_build_dir: "{{ bio_src }}/SnpSift-{{ item.version_number }}"
    snpeff_module_dir: "{{ bio_modules }}/snpeff"
    java_module: "{{ item.java_module | default('java/openjdk-17.0.2') }}"
    maven_module: "{{ item.maven_module | default('maven/3.9.11') }}"
    # Extract paths from module versions
    java_version: "{{ java_module.split('/')[1].replace('openjdk-', '') }}"
    maven_version: "{{ maven_module.split('/')[1] }}"
  tags:
    - never
    - snpeff{{ item.version_number }}
  environment:
    JAVA_HOME: "/software/common/java/jdk-{{ java_version }}"
    PATH: "/software/common/java/jdk-{{ java_version }}/bin:/software/common/maven/{{ maven_version }}/bin:{{ ansible_env.PATH }}"
  block:
    - name: Check if SnpEff JAR files already exist
      stat:
        path: "{{ snpeff_install_dir }}/snpEff.jar"
      register: jar_check

    - name: Build SnpEff from source (if needed)
      block:
        - name: Clone SnpEff repository
          git:
            repo: https://github.com/pcingola/SnpEff.git
            dest: "{{ snpeff_build_dir }}"
            version: "{{ item.snpeff_git_tag | default('HEAD') }}"
            force: yes

        - name: Clone SnpSift repository  
          git:
            repo: https://github.com/pcingola/SnpSift.git
            dest: "{{ snpsift_build_dir }}"
            version: "{{ item.snpsift_git_tag | default('HEAD') }}"
            force: yes

        - name: Install Maven dependencies for SnpEff libraries
          block:
            - name: Install Antlr jar to Maven local repository
              shell: |
                /software/common/maven/{{ maven_version }}/bin/mvn install:install-file \
                    -Dfile=antlr-4.5.1-complete.jar \
                    -DgroupId=org.antlr \
                    -DartifactId=antlr \
                    -Dversion=4.5.1 \
                    -Dpackaging=jar
              args:
                chdir: "{{ snpeff_build_dir }}/lib"

            - name: Install BioJava core jar to Maven local repository
              shell: |
                /software/common/maven/{{ maven_version }}/bin/mvn install:install-file \
                    -Dfile=biojava3-core-3.0.7.jar \
                    -DgroupId=org.biojava \
                    -DartifactId=biojava3-core \
                    -Dversion=3.0.7 \
                    -Dpackaging=jar
              args:
                chdir: "{{ snpeff_build_dir }}/lib"

            - name: Install BioJava structure jar to Maven local repository
              shell: |
                /software/common/maven/{{ maven_version }}/bin/mvn install:install-file \
                    -Dfile=biojava3-structure-3.0.7.jar \
                    -DgroupId=org.biojava \
                    -DartifactId=biojava3-structure \
                    -Dversion=3.0.7 \
                    -Dpackaging=jar
              args:
                chdir: "{{ snpeff_build_dir }}/lib"

        - name: Build SnpEff from source
          shell: |
            export VERSION=5.2
            export VERSION_UND=`echo $VERSION | tr '.' '_'`
            
            # Build SnpEff
            cd "{{ snpeff_build_dir }}"
            mvn clean compile assembly:single jar:jar
            
            # Install SnpEff JAR file in local Maven repo
            mvn install:install-file \
                -Dfile=target/SnpEff-$VERSION.jar \
                -DgroupId=org.snpeff \
                -DartifactId=SnpEff \
                -Dversion=$VERSION \
                -Dpackaging=jar \
                -DgeneratePom=true \
                --quiet
            
            # Build SnpSift  
            cd "{{ snpsift_build_dir }}"
            mvn clean compile assembly:single jar:jar
            
            # Install SnpSift JAR file in local Maven repo
            mvn install:install-file \
                -Dfile=target/SnpSift-$VERSION.jar \
                -DgroupId=org.snpsift \
                -DartifactId=SnpSift \
                -Dversion=$VERSION \
                -Dpackaging=jar \
                -DgeneratePom=true \
                --quiet
            
            # Update galaxy databases
            cd "{{ snpeff_build_dir }}"
            if [ -f "./scripts_build/galaxy.sh" ]; then
                ./scripts_build/galaxy.sh || echo "Galaxy script failed, continuing..."
            fi
            
            echo "Build done!"

      when: not jar_check.stat.exists

    - name: Create installation directories
      file:
        path: "{{ dir_path }}"
        state: directory
        mode: u=rwx,g=rwx,o=rx
      with_items:
        - "{{ snpeff_dir }}"
        - "{{ snpeff_install_dir }}"
      loop_control:
        loop_var: dir_path

    - name: Install built SnpEff to target directory
      shell: |
        # Copy SnpEff JAR files
        cp "{{ snpeff_build_dir }}/target/SnpEff-5.2-jar-with-dependencies.jar" "{{ snpeff_install_dir }}/snpEff.jar"
        cp "{{ snpeff_build_dir }}/snpEff.config" "{{ snpeff_install_dir }}/"
        
        # Copy SnpSift JAR files if it exists
        if [ -f "{{ snpsift_build_dir }}/target/SnpSift-5.2-jar-with-dependencies.jar" ]; then
            cp "{{ snpsift_build_dir }}/target/SnpSift-5.2-jar-with-dependencies.jar" "{{ snpeff_install_dir }}/SnpSift.jar"
        else
            echo "Warning: SnpSift JAR not found, skipping..."
        fi
        
        # Copy scripts directory if it exists
        if [ -d "{{ snpeff_build_dir }}/scripts" ]; then
            cp -r "{{ snpeff_build_dir }}/scripts/" "{{ snpeff_install_dir }}/"
        fi

    - name: Set snpeff data.dir
      lineinfile:
        path: "{{ snpeff_install_dir }}/snpEff.config"
        regexp: "data[.]dir =.*"
        line: "data.dir = {{ snpeff_dir }}/data"

    - name: Ensure snpEff shared data dir exists
      file:
        path: "{{ snpeff_dir }}/data"
        state: directory
        mode: u=rwx,g=rwx,o=rx

    - name: Install snpEffData (optional)
      shell: |
        /software/common/java/jdk-{{ java_version }}/bin/java -jar {{ snpeff_install_dir }}/snpEff.jar download {{ snpeff_data }}
      args:
        chdir: "{{ snpeff_install_dir }}"
      with_items: "{{ item.databases | default([]) }}"
      loop_control:
        loop_var: snpeff_data
      failed_when: false
      when: item.databases is defined and item.databases | length > 0

    - name: Install snpeff {{ item.version_number }} module
      block:
        - name: Check module dir
          file:
            path: "{{ snpeff_module_dir }}"
            state: directory
            mode: u=rwx,g=rwx,o=rx
        - name: Install SnpEff module file
          template:
            src: bio/snpeff.lua
            dest: "{{ snpeff_module_dir }}/{{ item.version_number }}.lua"
