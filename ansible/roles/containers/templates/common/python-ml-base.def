Bootstrap: localimage
From: {{ base_container_image }}

%labels
  Maintainer Dane Kennedy
  Version {{ item.version_number }}
  CUDA_Version {{ item.cuda_version }}
  cuDNN_Version {{ item.cudnn_version }}

%help
  Python ML Base {{ item.version_number }} container with CUDA {{ item.cuda_version }}, 
  cuDNN {{ item.cudnn_version }}, and uv package manager.
  This is the base container for Python ML environments.

%apprun python
  exec python "${@}"

%apprun python3
  exec python3 "${@}"

%apprun pip
  exec pip "${@}"

%apprun pip3
  exec pip3 "${@}"


%runscript
  exec python3 "${@}"

%environment
  export CUDA_VERSION={{ item.cuda_version }}
  export CUDNN_VERSION={{ item.cudnn_version }}
  
  # CUDA paths
  export CUDA_HOME=/usr/local/cuda
  export CUDA_ROOT=/usr/local/cuda
  export PATH=/usr/local/cuda/bin:${PATH}
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64:${LD_LIBRARY_PATH}
  export LIBRARY_PATH=/usr/local/cuda/lib64:${LIBRARY_PATH}
  export CPATH=/usr/local/cuda/include:${CPATH}
  
  
  # OpenCV and display
  export QT_X11_NO_MITSHM=1
  export DISPLAY=:0.0

%files
  uv-x86_64-unknown-linux-gnu/uv /usr/local/bin/uv
  {% if item.cudnn_deb_file is defined %}{{ item.cudnn_deb_file }} /tmp/{{ item.cudnn_deb_file }}{% endif %}

%post
  # Create Installation Directories and export paths. This is needed as part of post.
  # %environment scriptlet does not define these paths during %post, only after.
  export CUDA_VERSION={{ item.cuda_version }}
  export CUDNN_VERSION={{ item.cudnn_version }}
  export DEBIAN_FRONTEND=noninteractive

  # Verify uv is functional before proceeding
  echo "Checking uv installation..."
  chmod +x /usr/local/bin/uv
  /usr/local/bin/uv --version || (echo "FATAL ERROR: uv is not functional! Build cannot continue." && exit 1)
  echo "✓ uv is working properly"

  # Update apt
  apt-get update -y && apt-get upgrade -y && apt-get dist-upgrade -y

  # Install system packages for Python development and ML
  apt-get install -y \
    curl \
    python3-pip \
    python3-dev \
    python3-venv \
    {% if item.base_container_version_name == "noble" %}libgl1{% else %}libgl1-mesa-glx{% endif %} \
    libgl1-mesa-dev \
    libglib2.0-0 \
    libglib2.0-dev \
    ffmpeg \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libjpeg-dev \
    libpng-dev \
    libtiff-dev \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libxvidcore-dev \
    libx264-dev \
    libgtk-3-dev \
    libatlas-base-dev \
    gfortran \
    pkg-config \
    build-essential \
    cmake \
    git \
    vim \
    htop \
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    libopenblas-dev \
    liblapack-dev \
    libeigen3-dev

  # Install NVIDIA CUDA {{ item.cuda_version }}
  wget {{ item.cuda_keyring_url }}
  dpkg -i {{ item.cuda_keyring_file }}
  apt-get update
  
  # Install CUDA toolkit {{ item.cuda_version }}
  apt-get install -y {{ item.cuda_toolkit_package }}
  
  # Install cuDNN {{ item.cudnn_version }}
  {% if item.cudnn_deb_file is defined %}
  # For Ubuntu 24.04 Noble - use local repository method
  dpkg -i /tmp/{{ item.cudnn_deb_file }}
  cp /var/cudnn-local-repo-ubuntu2404-9.8.0/cudnn-*-keyring.gpg /usr/share/keyrings/
  apt-get update
  apt-get install -y cudnn
  rm -f /tmp/{{ item.cudnn_deb_file }}
  {% else %}
  # For Ubuntu 22.04 Jammy - use standard packages
  apt-get install -y libcudnn8 libcudnn8-dev
  {% endif %}

  # Set up CUDA paths for compilation
  export CUDA_HOME=/usr/local/cuda
  export CUDA_ROOT=/usr/local/cuda
  export PATH=/usr/local/cuda/bin:${PATH}
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64:${LD_LIBRARY_PATH}
  export LIBRARY_PATH=/usr/local/cuda/lib64:${LIBRARY_PATH}
  export CPATH=/usr/local/cuda/include:${CPATH}

  echo "✓ CUDA {{ item.cuda_version }}, cuDNN {{ item.cudnn_version }}, and uv are ready for Python ML environments"

  # Cleanup the container
  apt-get clean
  apt-get autoclean
  rm -f cuda-keyring_*.deb

%test
  # Test basic components
  python3 --version
  /usr/local/bin/uv --version
  nvcc --version || echo "CUDA test completed"