Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu20.04

%labels
  Maintainer Dane Kennedy
  Version {{ version_number }}
  AlphaFold
  Source https://github.com/google-deepmind/alphafold

%help
  AlphaFold {{ version_number }} - AI-powered protein structure prediction

  Built from official DeepMind source (latest main branch)

  Requirements:
    - NVIDIA GPU with CUDA 12.x support
    - Genetic databases (~2.6 TB) at configured data directory

  Usage:
    module load singularity alphafold/{{ version_number }}
    alphafold --fasta_paths=protein.fasta --max_template_date=2023-01-01 \
              --model_preset=monomer --output_dir=./output

%environment
  export PATH=/opt/conda/bin:/opt/hhsuite/bin:/app/alphafold:$PATH
  export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH
  export TF_FORCE_UNIFIED_MEMORY=1
  export XLA_PYTHON_CLIENT_MEM_FRACTION=4.0

%post
  export DEBIAN_FRONTEND=noninteractive

  # Install apt packages
  apt-get update --quiet
  apt-get install --no-install-recommends --yes --quiet \
    build-essential \
    cmake \
    cuda-command-line-tools-12-2 \
    git \
    hmmer \
    kalign \
    tzdata \
    wget
  rm -rf /var/lib/apt/lists/*
  apt-get autoremove --yes
  apt-get clean

  # Compile HHsuite from source
  git clone --branch v3.3.0 --single-branch https://github.com/soedinglab/hh-suite.git /tmp/hh-suite
  mkdir /tmp/hh-suite/build
  cd /tmp/hh-suite/build
  cmake -DCMAKE_INSTALL_PREFIX=/opt/hhsuite ..
  make -j$(nproc) && make install
  ln -s /opt/hhsuite/bin/* /usr/bin
  cd /
  rm -rf /tmp/hh-suite

  # Clone AlphaFold from official DeepMind repository (latest main branch)
  # Must happen before conda to avoid libffi conflicts with git-remote-https
  git clone --depth 1 {{ alphafold_repo_url }} /app/alphafold

  # Download stereo_chemical_props.txt
  wget -q -P /app/alphafold/alphafold/common/ \
    https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt

  # Install Miniconda
  wget -q -P /tmp https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  bash /tmp/Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
  rm /tmp/Miniconda3-latest-Linux-x86_64.sh

  # Install conda packages (CUDA runtime provided by base image)
  export PATH=/opt/conda/bin:$PATH
  export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH
  export CONDA_PLUGINS_AUTO_ACCEPT_TOS=yes
  conda install --quiet --yes conda==24.11.1 pip python=3.11
  conda install --quiet --yes --channel conda-forge openmm=8.0.0 pdbfixer
  conda clean --all --force-pkgs-dirs --yes

  # Install pip packages
  pip3 install --upgrade pip --no-cache-dir
  pip3 install -r /app/alphafold/requirements.txt --no-cache-dir
  pip3 install --upgrade --no-cache-dir \
    jax==0.4.26 \
    jaxlib==0.4.26+cuda12.cudnn89 \
    -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

  # Add SETUID bit to ldconfig for non-root users
  chmod u+s /sbin/ldconfig.real

  # Fix libffi symlink (workaround for undefined_symbol error)
  ln -sf /usr/lib/x86_64-linux-gnu/libffi.so.7 /opt/conda/lib/libffi.so.7

  # Create run script (ldconfig must run first for GPU visibility)
  cat > /app/run_alphafold.sh << 'EOF'
#!/bin/bash
ldconfig
python /app/alphafold/run_alphafold.py "$@"
EOF
  chmod +x /app/run_alphafold.sh

%runscript
  exec /app/run_alphafold.sh "$@"

%test
  python -c "import sys; print(f'Python {sys.version}')"
  python -c "import jax; print(f'JAX {jax.__version__}')"
