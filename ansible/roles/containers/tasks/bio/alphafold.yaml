- name: Create AlphaFold container
  vars:
    version_number: "{{ item.version_number }}"
    alphafold_repo_url: "{{ item.alphafold_repo_url }}"
    container_name: "alphafold_{{ version_number }}"
    container_recipe: "{{ bio_container_recipe_dir }}/{{ container_name }}.def"
    container_image: "{{ bio_container_dir }}/{{ container_name }}.sif"
    alphafold_module_dir: "{{ bio_modules }}/alphafold"
    alphafold_binary_dir: "{{ bio_container_dir }}/alphafold/{{ version_number }}"
    alphafold_data_dir: "{{ bio_data_dir }}/alphafold"
    alphafold_repo_dir: "{{ bio_src }}/alphafold"
  tags:
    - "alphafold{{ item.version_number }}"
    - never
  block:
    # Container build block
    - name: Build AlphaFold {{ version_number }} container
      tags:
        - alphafold_build
      block:
        - name: Copy recipe {{ container_recipe }}
          template:
            src: "bio/alphafold.def"
            dest: "{{ container_recipe }}"

        - name: Check for existence of alphafold container
          stat:
            path: "{{ container_image }}"
          register: container_exists

        - name: Build container {{ container_image }}
          command: "{{ singularity }} build {{ container_image }} {{ container_recipe }}"
          args:
            creates: "{{ container_image }}"
          become: true
          when: not container_exists.stat.exists



    # Module installation block
    - name: Install AlphaFold {{ container_name }} module
      block:
        - name: Ensure wrapper script directory exists
          file:
            path: "{{ alphafold_binary_dir }}"
            state: directory
            mode: u=rwx,g=rwx,o=rx

        - name: Create alphafold wrapper script
          template:
            src: "bio/alphafold.sh"
            dest: "{{ alphafold_binary_dir }}/alphafold"
            mode: 0755

        - name: Check module directory
          file:
            path: "{{ alphafold_module_dir }}"
            state: directory
            mode: u=rwx,g=rwx,o=rx

        - name: Install AlphaFold module file
          template:
            src: "bio/alphafold.lua"
            dest: "{{ alphafold_module_dir }}/{{ item.version_number }}.lua"

# Database download block (separate tags for long-running task)
- name: Download AlphaFold databases (WARNING - 2.6 TB, may take hours/days)
  vars:
    alphafold_data_dir: "{{ bio_data_dir }}/alphafold"
    alphafold_repo_dir: "{{ bio_src }}/alphafold"
    alphafold_repo_url: "{{ item.alphafold_repo_url }}"
  tags:
    - alphafold_data
    - never
  block:
    - name: Clone AlphaFold repository for database download scripts
      git:
        repo: "{{ alphafold_repo_url }}"
        dest: "{{ alphafold_repo_dir }}"
        depth: 1

    - name: Ensure AlphaFold data directory exists
      file:
        path: "{{ alphafold_data_dir }}"
        state: directory
        mode: u=rwx,g=rwx,o=rx
        group: "{{ admin_group }}"

    - name: Download AlphaFold databases using download_all_data.sh
      command: >
        bash {{ alphafold_repo_dir }}/scripts/download_all_data.sh {{ alphafold_data_dir }}
      args:
        creates: "{{ alphafold_data_dir }}/params"
      async: 43200
      poll: 300
      register: download_result

    - name: Display download result
      debug:
        msg: "Database download completed. Data location: {{ alphafold_data_dir }}"
      when: download_result.changed